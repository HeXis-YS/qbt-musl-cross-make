name: matrix qbt-musl-cross-make and release

on:
  - workflow_dispatch

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Host - wget musl-cross-make-master
        run: wget -qO musl-cross-make-master.tar.gz https://git.zv.io/toolchains/musl-cross-make/-/archive/master/musl-cross-make-master.tar.gz

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v3
        id: upload
        with:
          name: musl-cross-make-master-archive
          path: musl-cross-make-master.tar.gz

  build:
    needs: bootstrap
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        name: [musl-cross-make]
        os_id: [alpine]
        os_version_id: [edge]
        arch_type:
          [
            arm-linux-musleabihf,
            armv7l-linux-musleabihf,
            aarch64-linux-musl,
            x86_64-linux-musl,
            i486-linux-musl,
            i686-linux-musl,
          ]

        include:
          - arch_type: "arm-linux-musleabihf"
            arch_config: "--with-arch=armv6zk --with-tune=arm1176jzf-s --with-fpu=vfp --with-float=hard --with-abi=aapcs-linux"
          - arch_type: "armv7l-linux-musleabihf"
            arch_config: "--with-arch=armv7-a --with-tune=generic-armv7-a --with-fpu=vfpv3-d16 --with-float=hard --with-abi=aapcs-linux --with-mode=thumb"
          - arch_type: "aarch64-linux-musl"
            arch_config: "--with-arch=armv8-a --with-abi=lp64"
          - arch_type: "x86_64-linux-musl"
            arch_config: ""
          - arch_type: "i486-linux-musl"
            arch_config: "--with-arch=i486 --with-tune=generic --enable-cld"
          - arch_type: "i686-linux-musl"
            arch_config: "--with-arch=i686 --with-tune=generic --enable-cld"

    name: ${{ matrix.name }} ${{ matrix.arch_type }}

    steps:
      - uses: actions/checkout@v3

      - name: Host - phased updates ${{ github.event.inputs.distinct_id }}
        run: echo 'APT::Get::Always-Include-Phased-Updates "false";' | sudo tee /etc/apt/apt.conf.d/99-phased-updates

      - name: Host - update
        run: sudo apt-get update

      - name: Host - upgrade
        run: sudo apt-get -y upgrade

      - name: Host - Install host qemu-static
        run: sudo apt-get install -y qemu binfmt-support qemu-user-static

      - name: Host - Docker multiarch bootstrap
        run: sudo docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Host - Create docker multiarch container
        run: docker run --name multiarch -it -d -w /root -v ${{ github.workspace }}:/root ${{ matrix.os_id }}:${{ matrix.os_version_id }}

      - name: Docker - apk install build deps
        run: docker exec -w /root multiarch apk add autoconf automake bash bash-completion bison build-base cmake ccache curl findutils flex git graphviz libarchive-tools libtool linux-headers ncurses-dev patch perl pkgconf python3 python3-dev re2c rsync rsync tar texinfo ttf-freefont xz zip

      - name: Host - Download artifact - musl-cross-make-master
        uses: actions/download-artifact@v3
        id: download
        with:
          name: musl-cross-make-master-archive
          path: musl-cross-make-artifact-archive

      - name: Docker - Unpack musl-cross-make-master artifact
        run: docker exec -w /root/musl-cross-make-artifact-archive multiarch tar -xf musl-cross-make-master.tar.gz -C /root

      - name: Docker - Set ${{ matrix.arch_type }} musl to ${{ matrix.arch_config }}
        run: |
          docker exec -w /root multiarch sed "s|COMMON_CONFIG += CFLAGS|COMMON_CONFIG += ${{ matrix.arch_config }} CFLAGS|" -i config.mak
          docker exec -w /root multiarch cat config.mak

      - name: Host - Diff it
        run: diff config.mak config.mak musl-cross-make-master/config.mak

      - name: Docker - Copy updated config.mak to build directory
        run: docker exec -w /root multiarch cp -f config.mak musl-cross-make-master/config.mak

      - name: Docker - install ${{ matrix.arch_type }} toolchain
        run: docker exec -w /root/musl-cross-make-master multiarch make -j"$(nproc)" install TARGET=${{ matrix.arch_type }} OUTPUT=/root/build/${{ matrix.arch_type }}

      - name: Docker - archive ${{ matrix.arch_type }} toolchain
        run: docker exec -w /root/build multiarch tar -cJvf ${{ matrix.arch_type }}.tar.xz ${{ matrix.arch_type }}/

      - name: Host - set tag via date
        run: echo "github_tag=$(date +"%y%V")" >> $GITHUB_ENV

      - name: Host - set release info dynamically from config.mak
        run: printf "%s\n" "$(sed -rn "/CONFIG_SUB_REV = (.*)/,/LINUX_VER = (.*)/p" config.mak)" > realease_body.md

      - name: Create release - tag - assets
        uses: ncipollo/release-action@v1
        with:
          prerelease: false
          artifacts: "build/${{ matrix.arch_type }}.tar.xz"
          replacesArtifacts: true
          tag: "${{ env.github_tag }}"
          name: "musl-cross-make toolchains"
          bodyFile: "realease_body.md"
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
